{"version":3,"file":"core.min.mjs","sources":["../src/lib/renderer.mjs","../src/lib/component.mjs","../src/hooks/core_hooks.mjs"],"sourcesContent":["let currentElement;\r\nlet currentHookStateIndex = undefined;\r\nconst hookStateMap = new Map();\r\nconst passPropsMap = new Map();\r\nlet rendering = false;\r\nconst renderQueue = [];\r\nconst afterRenderQueue = [];\r\nconst render = element => {\r\n  currentElement = element;\r\n  if (!hookStateMap.has(element)) {\r\n    hookStateMap.set(element, []);\r\n  }\r\n  currentHookStateIndex = -1;\r\n  element.render();\r\n  const afterRenderQueueLength = afterRenderQueue.length;\r\n  let afterRenderQueueIndex = afterRenderQueueLength;\r\n  while (afterRenderQueueIndex--) {\r\n    const afterRenderQueueLocalIndex =\r\n      afterRenderQueueLength - afterRenderQueueIndex - 1;\r\n    afterRenderQueue[afterRenderQueueLocalIndex]();\r\n  }\r\n  afterRenderQueue.length = 0;\r\n  currentHookStateIndex = undefined;\r\n};\r\nconst unqeue = () => {\r\n  const queue = [...renderQueue];\r\n  renderQueue.length = 0;\r\n  rendering = true;\r\n  requestAnimationFrame(() => {\r\n    queue.forEach(element => render(element));\r\n    rendering = false;\r\n    if (renderQueue.length > 0) unqeue();\r\n  });\r\n};\r\nexport const queueRender = (element, force) => {\r\n  if (\r\n    (renderQueue.indexOf(element) === -1 && element._isConnected === true) ||\r\n    force\r\n  ) {\r\n    renderQueue.push(element);\r\n  }\r\n  if (!rendering) {\r\n    unqeue();\r\n  }\r\n};\r\nexport const getPassableProps = id => {\r\n  const props = passPropsMap.get(id);\r\n  passPropsMap.delete(id);\r\n  return props;\r\n};\r\nlet passPropsId = 100000;\r\nexport const addPassableProps = props => {\r\n  let id = passPropsId.toString(16);\r\n  passPropsId++;\r\n  if (id.length % 2) {\r\n    id = \"0\" + id;\r\n  }\r\n  passPropsMap.set(id, props);\r\n  return id;\r\n};\r\nexport const prps = props => {\r\n  let id = addPassableProps(props);\r\n  return {\r\n    \"data-props\": id\r\n  };\r\n};\r\nexport const nextHook = () => {\r\n  if (currentHookStateIndex === undefined) {\r\n    throw new Error(\"Using hooks outside of a component is forbidden!\");\r\n  }\r\n  currentHookStateIndex = currentHookStateIndex + 1;\r\n};\r\nexport const createHook = hook => (...args) => {\r\n  nextHook();\r\n  return hook(...args);\r\n};\r\nexport const queueAfterRender = callback => {\r\n  afterRenderQueue.push(callback);\r\n};\r\n\r\nexport const getCurrentHookState = initialState => {\r\n  const hookState = hookStateMap.get(currentElement);\r\n  if (!hookState[currentHookStateIndex]) {\r\n    hookState[currentHookStateIndex] = initialState;\r\n    return initialState;\r\n  }\r\n  return hookState[currentHookStateIndex];\r\n};\r\n\r\nexport const getCurrentElement = () => {\r\n  return currentElement;\r\n};\r\n\r\nexport const defaultRenderer = (view, shadowRoot) => {\r\n  if (\r\n    !(view instanceof NodeList\r\n      ? shadowRoot.contains(view[0])\r\n      : shadowRoot.contains(view))\r\n  ) {\r\n    shadowRoot.innerHTML = \"\";\r\n    if (view instanceof NodeList) {\r\n      view.forEach(node => shadowRoot.appendChild(node));\r\n    } else {\r\n      shadowRoot.appendChild(view);\r\n    }\r\n  }\r\n};\r\n","import { queueRender, defaultRenderer, getPassableProps } from \"./renderer.mjs\";\r\nexport { prps } from \"./renderer.mjs\";\r\nconst componentMap = new Map();\r\nfunction addComponent(name, options = {}) {\r\n  class Component extends HTMLElement {\r\n    constructor() {\r\n      super();\r\n      this._props = {};\r\n      this._renderer = defaultRenderer;\r\n      this._isConnected = false;\r\n    }\r\n    connectedCallback() {\r\n      if (!this._shadowRoot) {\r\n        this._shadowRoot = this.attachShadow({\r\n          mode: \"open\",\r\n          ...(options.shadowOptions ? options.shadowOptions : {})\r\n        });\r\n      }\r\n      if (!this._isConnected) {\r\n        this._isConnected = true;\r\n        queueRender(this);\r\n      }\r\n    }\r\n    disconnectedCallback() {\r\n      if (this._isConnected) {\r\n        this._isConnected = false;\r\n        queueRender(this, true);\r\n      }\r\n    }\r\n    render() {\r\n      const propsId = this.getAttribute(\"data-props\");\r\n      if (propsId) {\r\n        this._props = getPassableProps(propsId);\r\n        this.skipQueue = true;\r\n        this.removeAttribute(\"data-props\");\r\n      }\r\n      const view = componentMap.get(name)(this._props);\r\n      this._renderer(view, this._shadowRoot);\r\n      this.init = false;\r\n    }\r\n    attributeChangedCallback(attrName, oldVal, newVal) {\r\n      if (this.init) {\r\n        return;\r\n      }\r\n      if (!this.skipQueue && oldVal !== newVal) {\r\n        queueRender(this);\r\n      }\r\n      this.skipQueue = false;\r\n    }\r\n    static get observedAttributes() {\r\n      let observedAttributes = [\"data-props\"];\r\n      if (options.observedAttributes) {\r\n        observedAttributes = observedAttributes.concat(\r\n          options.observedAttributes\r\n        );\r\n      }\r\n      return observedAttributes;\r\n    }\r\n  }\r\n  customElements.define(name, Component);\r\n}\r\nexport const defineComponent = (name, component, options = {}) => {\r\n  if (!componentMap.has(name)) {\r\n    componentMap.set(name, component);\r\n    addComponent(name, options);\r\n  } else {\r\n    console.warn(`Component ${name} was already defined.`);\r\n  }\r\n};\r\n","import {\r\n  getCurrentElement,\r\n  getCurrentHookState,\r\n  queueRender,\r\n  queueAfterRender,\r\n  createHook\r\n} from \"../lib/renderer.mjs\";\r\n\r\nexport const useHostElement = createHook(() => {\r\n  return getCurrentElement();\r\n});\r\nexport const useShadowRoot = createHook(() => {\r\n  return useHostElement()._shadowRoot;\r\n});\r\nexport const useReducer = createHook((reducer, initialState) => {\r\n  const hookState = getCurrentHookState({\r\n    reducer,\r\n    state: initialState\r\n  });\r\n  const element = useHostElement();\r\n  return [\r\n    hookState.state,\r\n    action => {\r\n      hookState.state = hookState.reducer(hookState.state, action);\r\n      queueRender(element);\r\n    }\r\n  ];\r\n});\r\nexport const useState = createHook(initialState => {\r\n  const [state, dispatch] = useReducer((_, action) => {\r\n    return action.value;\r\n  }, initialState);\r\n\r\n  return [\r\n    state,\r\n    newState =>\r\n      dispatch({\r\n        type: \"set_state\",\r\n        value: newState\r\n      })\r\n  ];\r\n});\r\nexport const useRenderer = createHook(rendererIn => {\r\n  const renderer = getCurrentHookState(rendererIn);\r\n  const element = useHostElement();\r\n  element._renderer = renderer;\r\n});\r\nexport const useEffect = createHook((effect, values) => {\r\n  const state = getCurrentHookState({\r\n    effect,\r\n    values,\r\n    cleanUp: () => {}\r\n  });\r\n  const isConnected = useConnectedState();\r\n  if (isConnected) {\r\n    let nothingChanged = false;\r\n    if (state.values !== values && state.values && state.values.length > 0) {\r\n      nothingChanged = true;\r\n      let index = state.values.length;\r\n\r\n      while (index--) {\r\n        if (values[index] !== state.values[index]) {\r\n          nothingChanged = false;\r\n          break;\r\n        }\r\n      }\r\n      state.values = values;\r\n    }\r\n    if (!nothingChanged) {\r\n      state.cleanUp();\r\n      queueAfterRender(() => {\r\n        const cleanUp = state.effect();\r\n        if (cleanUp) {\r\n          state.cleanUp = cleanUp;\r\n        }\r\n      });\r\n    }\r\n  } else {\r\n    state.cleanUp();\r\n    state.cleanUp = () => {};\r\n  }\r\n});\r\nexport const useAttribute = createHook(attributeName => {\r\n  const element = useHostElement();\r\n  const attributeValue = element.getAttribute(attributeName);\r\n  return [\r\n    attributeValue,\r\n    value => {\r\n      element.skipQueue = true;\r\n      element.setAttribute(attributeName, value);\r\n    }\r\n  ];\r\n});\r\nexport const useCSS = createHook((parts, ...slots) => {\r\n  let styles;\r\n  if (parts instanceof Array) {\r\n    styles = parts\r\n      .map((part, index) => {\r\n        if (slots[index]) {\r\n          return part + slots[index];\r\n        } else {\r\n          return part;\r\n        }\r\n      })\r\n      .join(\"\");\r\n  } else {\r\n    styles = parts;\r\n  }\r\n  styles = styles.replace(/ +(?= )/g, \"\").replace(/\\n/g, \"\");\r\n  const shadowRoot = useShadowRoot();\r\n  const style = document.createElement(\"style\");\r\n  style.innerHTML = styles;\r\n  useEffect(() => {\r\n    shadowRoot.appendChild(style);\r\n    return () => {\r\n      shadowRoot.removeChild(style);\r\n    };\r\n  });\r\n});\r\nexport const useExposeMethod = createHook((name, method) => {\r\n  const element = useHostElement();\r\n  element[name] = (...args) => method(...args);\r\n});\r\nexport const useConnectedState = createHook(() => {\r\n  const element = useHostElement();\r\n  return element._isConnected;\r\n});\r\n"],"names":["currentElement","currentHookStateIndex","undefined","hookStateMap","Map","passPropsMap","rendering","renderQueue","afterRenderQueue","unqeue","queue","length","requestAnimationFrame","forEach","element","has","set","render","afterRenderQueueLength","afterRenderQueueIndex","queueRender","force","indexOf","_isConnected","push","getPassableProps","id","props","get","delete","passPropsId","prps","data-props","toString","addPassableProps","createHook","hook","args","Error","nextHook","getCurrentHookState","initialState","hookState","defaultRenderer","view","shadowRoot","NodeList","contains","innerHTML","node","appendChild","componentMap","defineComponent","name","component","options","console","warn","customElements","define","HTMLElement","[object Object]","super","this","_props","_renderer","_shadowRoot","attachShadow","mode","shadowOptions","propsId","getAttribute","skipQueue","removeAttribute","init","attrName","oldVal","newVal","observedAttributes","concat","addComponent","useHostElement","getCurrentElement","useShadowRoot","useReducer","reducer","state","action","useState","dispatch","_","value","newState","type","useRenderer","rendererIn","renderer","useEffect","effect","values","cleanUp","useConnectedState","nothingChanged","index","callback","queueAfterRender","useAttribute","attributeName","setAttribute","useCSS","parts","slots","styles","Array","map","part","join","replace","style","document","createElement","removeChild","useExposeMethod","method"],"mappings":"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"}